#!/bin/bash
# Copyright (c) 2021 Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

# Make sure this is run via source or .
if ! (return 0 2>/dev/null); then
  echo "ERROR: Usage 'source setup.env'"
  exit
fi


# Get the code location
MSDD_CODE="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../.." &> /dev/null && pwd )"
# Double check we have the right location
if ! test -d $MSDD_CODE/../microservices-datadriven; then
  echo "ERROR: This script is in the wrong location and cannot be sourced"
  return 1
fi
source $MSDD_CODE/common/source.env


# Source our environment
source $MSDD_WORKSHOP_CODE/$DCMS_WORKSHOP/source.env


# Create the workshop state folder if necessary
if ! test -f $DCMS_STATE; then
  echo "Setup has not been executed and so nothing to teardown"
fi


# If this is the first run of teardown then take an archive copy of the state (TODO)


# Run the teardown
cd $DCMS_STATE
if ! provisioning-destroy; then
  echo "ERROR: Teardown failed"
  return 1
fi
echo "Teardown completed successfully"