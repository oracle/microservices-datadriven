#!/bin/bash
# Copyright (c) 2021 Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

# Make sure this is run via source or .
if ! (return 0 2>/dev/null); then
  echo "ERROR: Usage 'source teardown.env'"
  exit
fi


# Get the code location
MSDD_CODE="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../.." &> /dev/null && pwd )"
# Double check we have the right location
if ! test -d $MSDD_CODE/../microservices-datadriven; then
  echo "ERROR: This script is in the wrong location and cannot be sourced"
  return 1
fi
source $MSDD_CODE/common/source.env


# Source our environment
source $MSDD_WORKSHOP_CODE/$DCMS_WORKSHOP/source.env


# Check the workshop state folder if necessary
if ! test -d $DCMS_STATE; then
  echo "Setup has not been executed and so nothing to teardown"
  return 1
fi


# Check for Live Labs
if test $(state_get RUN_TYPE) == "LL"; then
  echo "No need to teardown in Live Labs"
  return 1
fi


# Take an archive copy of the state
BACKUP_DIR=${DCMS_STATE}_$( date '+%F_%H:%M:%S' )
mkdir -p $BACKUP_DIR
cp -r $DCMS_STATE/* $BACKUP_DIR/


# Run the teardown
cd $DCMS_STATE
if ! provisioning-destroy 2>&1 ; then
  echo "ERROR: Teardown failed"
  return 1
fi | tee -ai $DCMS_LOG_DIR/teardown.log


# Remove the source.env from .bashrc
sed -i.bak '/microservices-datadriven/d' ~/.bashrc


echo "Teardown completed successfully"