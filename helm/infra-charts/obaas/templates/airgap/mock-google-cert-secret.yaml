## Copyright (c) 2024, 2026, Oracle and/or its affiliates.
## Licensed under the Universal Permissive License v1.0 as shown at http://oss.oracle.com/licenses/upl.

{{- if .Values.global.airGapped }}

{{- /*
  In air-gapped environments, components that verify Google OAuth endpoints fail
  because they cannot reach accounts.google.com. This template generates a
  self-signed TLS certificate so that the mock-google-cert secret exists in the
  cluster, satisfying those checks without external connectivity.

  Uses `lookup` to skip regeneration if the secret already exists (same pattern
  as templates/database/auth-secret.yaml). The "helm.sh/resource-policy: keep"
  annotation prevents Helm from deleting the secret on upgrade when `lookup`
  causes it to be omitted from the manifest.
*/ -}}

{{- $secretName := "mock-google-cert" }}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{- if not $existing }}
{{- $cert := genSelfSignedCert "accounts.google.com" nil (list "accounts.google.com") 365 }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    app.kubernetes.io/component: airgap
    {{- include "obaas.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: kubernetes.io/tls
data:
  tls.crt: {{ $cert.Cert | b64enc }}
  tls.key: {{ $cert.Key | b64enc }}
{{- end }}

{{- end }}
