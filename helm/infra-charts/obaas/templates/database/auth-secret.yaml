## Copyright (c) 2024, 2026, Oracle and/or its affiliates.
## Licensed under the Universal Permissive License v1.0 as shown at http://oss.oracle.com/licenses/upl.
# spell-checker: ignore nindent freepdb1

{{- if .Values.database }}
{{- include "obaas.database.validateOtherType" . }}
{{- include "obaas.database.validatePrivAuthN" . }}

{{- /*
  Database authentication secrets use a `lookup` guard to avoid regenerating
  random passwords on upgrade. However, when `lookup` finds an existing secret,
  the resource is omitted from the rendered manifest, which causes Helm to
  interpret it as removed and delete it. The "helm.sh/resource-policy: keep"
  annotation prevents Helm from deleting the secret in this case, preserving the
  credentials that match the SIDB database.
*/ -}}

{{- /* Database Authentication Secret (OBAAS_USER) */ -}}
{{- $authSecretName := include "obaas.databaseSecret" . }}
{{- $authUserProvided := and .Values.database.authN .Values.database.authN.secretName }}
{{- $authExists := lookup "v1" "Secret" .Release.Namespace $authSecretName }}
{{- $createAuth := and (not $authExists) (not $authUserProvided) }}
{{- if $createAuth }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $authSecretName }}
  labels:
    app.kubernetes.io/component: database
    {{- include "obaas.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
stringData:
  {{- $authN := .Values.database.authN | default dict }}
  {{ $authN.usernameKey | default "username" }}: "OBAAS_USER"
  {{ $authN.passwordKey | default "password" }}: {{ include "obaas.randomPassword" . | quote }}
  {{ $authN.serviceKey | default "service" }}: {{ include "obaas.database.serviceValue" . | quote }}
{{- end }}
{{- /* Database Privileged User Secret (ADMIN/SYSTEM) */ -}}
{{- $privSecretName := include "obaas.databasePrivSecret" . }}
{{- $privUserProvided := and .Values.database.privAuthN .Values.database.privAuthN.secretName }}
{{- $privExists := lookup "v1" "Secret" .Release.Namespace $privSecretName }}
{{- $createPriv := and (not $privExists) (not $privUserProvided) }}
{{- if $createPriv }}
{{ if $createAuth }}---{{ end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $privSecretName }}
  labels:
    app.kubernetes.io/component: database
    {{- include "obaas.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
stringData:
  {{- $privAuthN := .Values.database.privAuthN | default dict }}
  {{ $privAuthN.usernameKey | default "username" }}: {{ if eq (include "obaas.database.isADB" .) "true" }}"ADMIN"{{ else }}"SYSTEM"{{ end }}
  {{ $privAuthN.passwordKey | default "password" }}: {{ include "obaas.randomPassword" . | quote }}
  {{ $privAuthN.serviceKey | default "service" }}: {{ include "obaas.database.serviceValue" . | quote }}
{{- end }}
{{- end }}
