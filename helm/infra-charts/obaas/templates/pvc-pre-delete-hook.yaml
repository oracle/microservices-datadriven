## Copyright (c) 2024, 2026, Oracle and/or its affiliates.
## Licensed under the Universal Permissive License v1.0 as shown at http://oss.oracle.com/licenses/upl.
{{- if .Values.global.cleanupPVCs }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Release.Name }}-pvc-pre-delete
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Release.Name }}-pvc-pre-delete
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Release.Name }}-pvc-pre-delete
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Release.Name }}-pvc-pre-delete
subjects:
- kind: ServiceAccount
  name: {{ .Release.Name }}-pvc-pre-delete
  namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-pvc-pre-delete
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-weight": "-9"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  template:
    metadata:
      name: {{ .Release.Name }}-pvc-pre-delete
    spec:
      serviceAccountName: {{ .Release.Name }}-pvc-pre-delete
      restartPolicy: Never
      containers:
      - name: pvc-cleanup
        image: {{ .Values.global.utilities.kubectl.image.registry }}/{{ .Values.global.utilities.kubectl.image.repository }}:{{ .Values.global.utilities.kubectl.image.tag }}
        command:
        - sh
        - -c
        - |
          set -e
          echo "=== PVC Pre-Delete Hook ==="
          echo "Cleaning up all PVCs in namespace {{ .Release.Namespace }}..."

          PVC_LIST=$(kubectl get pvc -n {{ .Release.Namespace }} -o name 2>/dev/null || echo "")

          if [ -z "$PVC_LIST" ]; then
            echo "No PVCs found. Nothing to clean up."
            exit 0
          fi

          echo "Found PVCs:"
          echo "$PVC_LIST"

          for pvc in $PVC_LIST; do
            kubectl delete $pvc -n {{ .Release.Namespace }} --wait=false
            echo "Deleted $pvc"
          done

          echo "Waiting for PVC deletions to process..."
          sleep 5

          REMAINING=$(kubectl get pvc -n {{ .Release.Namespace }} 2>/dev/null | grep -v "^NAME" | wc -l || echo "0")

          if [ "$REMAINING" -gt 0 ]; then
            echo "Note: $REMAINING PVC(s) still terminating (may be waiting for pod termination)"
            kubectl get pvc -n {{ .Release.Namespace }}
          else
            echo "All PVCs successfully removed"
          fi

          echo "=== PVC cleanup complete ==="
{{- end }}
