#!/bin/bash
# Copyright (c) 2021 Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

# Make sure this is run via source or .
if ! (return 0 2>/dev/null); then
  echo "ERROR: Usage 'source setup.env'"
  return 1
fi

# This script must be run with DCMS code in the current directory
if ! test -d microservices-datadriven; then
  echo "ERROR: This script must be run with the microservices-datadriven code in the current directory"
  return 1
fi

export MSDD_CODE_HOME=$PWD/microservices-datadriven

DCMS_WORKSHOP_HOME=$PWD/dcmsrun
mkdir -p $DCMS_WORKSHOP_HOME

DCMS_WORKSHOP_LOG=$DCMS_WORKSHOP_HOME/log
mkdir -p $DCMS_WORKSHOP_LOG

if test -f $DCMS_WORKSHOP_HOME/output.env; then
  # Workshop setup has compketed
  return 
fi

SETUP_SCRIPT="$MSDD_CODE_HOME/workshop/dcms-oci/setup.sh"
if ps -ef | grep "$SETUP_SCRIPT" | grep -v grep; then
  echo "The $SETUP_SCRIPT is already running.  If you want to restart it, kill it and then rerun."
  return 1
fi


$SETUP_SCRIPT $DCMS_WORKSHOP_HOME 2>&1 | tee -ai $DCMS_WORKSHOP_LOG/setup.log


if ! test -f $DCMS_WORKSHOP_HOME/output.env; then
  # We ran setup and no output file, so looks like we failed
  echo "ERROR: Data-Centric Microservices workshop setup has failed"
  return 1
fi

source $DCMS_WORKSHOP_HOME/output.env